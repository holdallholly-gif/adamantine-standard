name: Verification & Pages Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Ensure docs/ and a default dashboard exist
        run: |
          set -e
          mkdir -p docs
          if [ ! -f docs/index.html ]; then
            cat > docs/index.html <<'HTML'
<!doctype html><html lang="en"><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Adamantine Verification Dashboard</title>
<style>
  body{margin:0;background:#0a0a0a;color:#f5f5f5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;line-height:1.45}
  header{padding:48px 20px 24px;text-align:center;border-bottom:1px solid #1c1c1c}
  h1{margin:0 0 10px;color:#4cd964}
  main{max-width:900px;margin:0 auto;padding:24px 20px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #333;font-size:12px}
  .ok{background:rgba(76,217,100,.12);color:#4cd964;border-color:rgba(76,217,100,.35)}
  .mismatch{background:rgba(255,92,92,.12);color:#ff5c5c;border-color:rgba(255,92,92,.35)}
  .missing{background:rgba(255,255,255,.08);color:#ddd;border-color:#333}
  table{width:100%;border-collapse:collapse;border:1px solid #1c1c1c;border-radius:12px;overflow:hidden}
  th,td{padding:10px 12px;border-bottom:1px solid #1c1c1c;text-align:left;font-size:14px}
  th{background:#0f0f0f}
  .hint{color:#b9b9b9;font-size:13px}
</style>
<header>
  <h1>✅ Adamantine Verification Dashboard</h1>
  <p class="hint">Loads <code>repro_log.jsonl</code> every 30s and shows the latest results.</p>
</header>
<main>
  <div class="hint" id="upd">Last updated: —</div>
  <div id="status" class="badge missing">Loading…</div>
  <table id="tbl" hidden>
    <thead><tr><th>Time (UTC)</th><th>File</th><th>Result</th><th>SHA-256 (short)</th><th>Commit</th></tr></thead>
    <tbody id="body"></tbody>
  </table>
  <p id="empty" class="hint" hidden>No entries yet. Commit a file into <code>docs/</code> to verify.</p>
  <p id="err" class="hint" hidden>Couldn’t load <code>repro_log.jsonl</code>.</p>
</main>
<script>
const upd=document.getElementById('upd'), st=document.getElementById('status'),
      tbl=document.getElementById('tbl'), body=document.getElementById('body'),
      empty=document.getElementById('empty'), err=document.getElementById('err');
async function load(){
  try{
    const r=await fetch('repro_log.jsonl',{cache:'no-store'});
    if(!r.ok) throw new Error(r.status);
    const lines=(await r.text()).split('\n').map(s=>s.trim()).filter(Boolean);
    body.innerHTML='';
    if(lines.length===0){tbl.hidden=true;empty.hidden=false;err.hidden=true;st.textContent='No entries yet';st.className='badge missing'}
    else{
      for(let i=lines.length-1;i>=0;i--){
        try{
          const row=JSON.parse(lines[i]);
          const tr=document.createElement('tr');
          const sha=(row.sha256||'—'); const short=sha?sha.slice(0,10)+(sha?'…':''):'—';
          tr.innerHTML=`<td>${row.timestamp||'—'}</td><td>${row.file||'—'}</td>
            <td><span class="badge ${row.result==='ok'?'ok':row.result==='mismatch'?'mismatch':'missing'}">${row.result||'missing'}</span></td>
            <td>${short}</td><td>${(row.commit||'—').slice(0,7)}</td>`;
          body.appendChild(tr);
        }catch{}
      }
      const latest=JSON.parse(lines[lines.length-1]); const res=latest.result||'missing';
      st.textContent=res==='ok'?'Verified':res==='mismatch'?'Changed':'Missing';
      st.className='badge '+(res==='ok'?'ok':res==='mismatch'?'mismatch':'missing');
      tbl.hidden=false; empty.hidden=true; err.hidden=true;
    }
    upd.textContent='Last updated: '+new Date().toISOString().replace('T',' ').replace('Z',' UTC');
  }catch(e){tbl.hidden=true;empty.hidden=true;err.hidden=false;st.textContent='Error';st.className='badge mismatch';upd.textContent='Last updated: —'}
}
load(); setInterval(load,30000);
</script>
</html>
HTML
          fi

      - name: Ensure log file exists
        run: |
          touch docs/repro_log.jsonl

      - name: Write a verification entry (edit targets as you wish)
        run: |
          set -e
          ts=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          files="docs/Certified_Record_v1.0.pdf"
          for f in $files; do
            if [ -f "$f" ]; then
              sha=$(sha256sum "$f" | cut -d ' ' -f1)
              res=ok
            else
              sha=""
              res=missing
            fi
            echo "{\"timestamp\":\"$ts\",\"file\":\"$f\",\"sha256\":\"$sha\",\"commit\":\"${GITHUB_SHA}\",\"result\":\"$res\"}" >> docs/repro_log.jsonl
          done

  deploy:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload dashboard
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
