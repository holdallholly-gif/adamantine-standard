name: Deploy Verification Dashboard

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Prepare log
        run: mkdir -p docs && touch docs/repro_log.jsonl

      - name: Verify files
        run: |
          set -e
          ts=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          for f in docs/Certified_Record_v1.0.pdf; do
            if [ -f "$f" ]; then
              sha=$(sha256sum "$f" | cut -d ' ' -f1)
              res=ok
            else
              sha=""
              res=missing
            fi
            echo "{\"timestamp\":\"$ts\",\"file\":\"$f\",\"sha256\":\"$sha\",\"commit\":\"${GITHUB_SHA}\",\"result\":\"$res\"}" >> docs/repro_log.jsonl
          done

  deploy:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Pages
        uses: actions/configure-pages@v5

      - name: Upload dashboard
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
