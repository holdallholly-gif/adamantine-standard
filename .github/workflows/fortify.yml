name: Fortify AST Scan (Refined)

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read

jobs:
  fortify:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # Preflight: stop early if any secret is missing
      - name: Verify required secrets
        shell: bash
        run: |
          missing=()
          [ -z "${{ secrets.FOD_URL }}" ] && missing+=("FOD_URL")
          [ -z "${{ secrets.FOD_CLIENT_ID }}" ] && missing+=("FOD_CLIENT_ID")
          [ -z "${{ secrets.FOD_CLIENT_SECRET }}" ] && missing+=("FOD_CLIENT_SECRET")
          [ -z "${{ secrets.FOD_TENANT }}" ] && missing+=("FOD_TENANT")
          [ -z "${{ secrets.FOD_RELEASE_ID }}" ] && missing+=("FOD_RELEASE_ID")

          if [ ${#missing[@]} -gt 0 ]; then
            echo "❌ Missing secrets: ${missing[*]}"
            echo "Fix: Repo → Settings → Secrets and variables → Actions → add each one."
            exit 1
          else
            echo "✅ All required secrets are present."
          fi

      # Run the Fortify scan (FoD upload method)
      - name: Run Fortify scan
        uses: fortify/github-action@v2
        with:
          fod_base_url: ${{ secrets.FOD_URL }}
          fod_client_id: ${{ secrets.FOD_CLIENT_ID }}
          fod_client_secret: ${{ secrets.FOD_CLIENT_SECRET }}
          fod_tenant: ${{ secrets.FOD_TENANT }}
          fod_release_id: ${{ secrets.FOD_RELEASE_ID }}
          scan_method: "FoDUpload"               # upload and scan in FoD
          policy_failure_break_build: false      # don't fail build on findings yet

      # Always show a simple result line
      - name: Show result
        if: always()
        run: echo "Fortify scan finished with status: ${{ job.status }}"

      # Human-readable audit summary on the run page
      - name: Write audit summary
        if: always()
        run: |
          echo "### Fortify Audit" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp (UTC): $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_STEP_SUMMARY

      # Machine-readable audit artifact (downloadable JSON)
      - name: Create audit JSON
        if: always()
        run: |
          ts=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          cat > fortify_audit.json <<EOF
          {
            "workflow": "Fortify AST Scan",
            "status": "${{ job.status }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "timestamp_utc": "$ts"
          }
          EOF

      - name: Upload audit artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fortify-audit-${{ github.run_id }}
          path: fortify_audit.json
          retention-days: 30
